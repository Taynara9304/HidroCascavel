// hooks/useTabelaAnalises.js - VERS√ÉO CORRIGIDA
import { useState, useEffect, useMemo } from 'react';
import { 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  orderBy, 
  query,
  serverTimestamp,
  where,
  Timestamp
} from 'firebase/firestore';
import { db } from '../services/firebaseConfig';
import { useAuth } from '../contexts/authContext';

const useTabelaAnalises = () => {
  const [analyses, setAnalyses] = useState([]);
  const [pocos, setPocos] = useState([]);
  const [analistas, setAnalistas] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [sortField, setSortField] = useState('dataAnalise');
  const [sortDirection, setSortDirection] = useState('desc');

  const { user, userData } = useAuth();

  console.log('üîÑ useTabelaAnalises: Hook inicializado');

  // Buscar an√°lises em tempo real
  useEffect(() => {
    console.log('üì° useTabelaAnalises: Configurando listener do Firebase...');
    setLoading(true);
    setError(null);
    
    try {
      const analysesCollection = collection(db, 'analysis'); // ‚úÖ Cole√ß√£o correta: "analysis"
      console.log('üì° useTabelaAnalises: Cole√ß√£o analysis referenciada');
      
      let q;
      
      // Filtros baseados no tipo de usu√°rio
      if (userData?.tipoUsuario === 'proprietario') {
        // Propriet√°rio v√™ apenas an√°lises dos seus po√ßos
        q = query(
          analysesCollection, 
          where('idProprietario', '==', user.uid), // ‚úÖ Campo correto: idProprietario
          orderBy('dataAnalise', 'desc')
        );
        console.log('üîç useTabelaAnalises: Filtro para propriet√°rio');
      } else if (userData?.tipoUsuario === 'analista') {
        // Analista v√™ an√°lises que ele criou
        q = query(
          analysesCollection,
          where('idAnalista', '==', user.uid), // ‚úÖ Campo correto: idAnalista
          orderBy('dataAnalise', 'desc')
        );
        console.log('üîç useTabelaAnalises: Filtro para analista');
      } else {
        // Admin v√™ todas as an√°lises
        q = query(analysesCollection, orderBy('dataAnalise', 'desc'));
        console.log('üîç useTabelaAnalises: Filtro para admin - todas an√°lises');
      }
      
      const unsubscribe = onSnapshot(q, 
        (snapshot) => {
          console.log('üì° useTabelaAnalises: Snapshot recebido -', snapshot.docs.length, 'documentos');
          
          const analysesData = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              ...data,
              // Converter Timestamp para Date se necess√°rio
              dataAnalise: data.dataAnalise?.toDate?.() || data.dataAnalise,
            };
          });
          
          setAnalyses(analysesData);
          setLoading(false);
          console.log('‚úÖ useTabelaAnalises: Estado atualizado com', analysesData.length, 'an√°lises');
        },
        (error) => {
          console.error('‚ùå useTabelaAnalises: Erro no listener:', error);
          setError('Erro ao carregar an√°lises: ' + error.message);
          setLoading(false);
        }
      );

      return () => {
        console.log('üì° useTabelaAnalises: Removendo listener');
        unsubscribe();
      };
    } catch (err) {
      console.error('‚ùå useTabelaAnalises: Erro ao configurar listener:', err);
      setError('Erro de configura√ß√£o: ' + err.message);
      setLoading(false);
    }
  }, [user, userData]);

  // Buscar po√ßos
  useEffect(() => {
    console.log('üì° useTabelaAnalises: Buscando po√ßos...');
    
    const pocosCollection = collection(db, 'wells');
    let q;
    
    if (userData?.tipoUsuario === 'proprietario') {
      q = query(pocosCollection, where('userId', '==', user.uid), orderBy('nomeProprietario'));
    } else {
      q = query(pocosCollection, orderBy('nomeProprietario'));
    }
    
    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        const pocosData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setPocos(pocosData);
        console.log('‚úÖ useTabelaAnalises:', pocosData.length, 'po√ßos carregados');
      },
      (error) => {
        console.error('‚ùå useTabelaAnalises: Erro ao carregar po√ßos:', error);
      }
    );

    return () => unsubscribe();
  }, [user, userData]);

  // Buscar analistas - VERS√ÉO SIMPLIFICADA (sem filtro complexo)
  useEffect(() => {
    console.log('üì° useTabelaAnalises: Buscando analistas...');
    
    const usersCollection = collection(db, 'users');
    // Query simples sem filtro complexo para evitar erro de √≠ndice
    const q = query(usersCollection, orderBy('nome'));
    
    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        const allUsers = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Filtrar localmente para obter apenas analistas e administradores
        const analistasData = allUsers.filter(user => 
          user.tipoUsuario === 'analista' || user.tipoUsuario === 'administrador'
        );
        
        setAnalistas(analistasData);
        console.log('‚úÖ useTabelaAnalises:', analistasData.length, 'analistas carregados (filtro local)');
      },
      (error) => {
        console.error('‚ùå useTabelaAnalises: Erro ao carregar usu√°rios:', error);
        setAnalistas([]); // Definir como array vazio em caso de erro
      }
    );

    return () => unsubscribe();
  }, []);

  // Adicionar an√°lise - VERS√ÉO COMPAT√çVEL COM SUA ESTRUTURA
  const addAnalysis = async (analysisData) => {
    try {
      console.log('‚ûï useTabelaAnalises: Iniciando cadastro...', analysisData);
      
      const analysesCollection = collection(db, 'analysis');
      
      // ‚úÖ ESTRUTURA COMPAT√çVEL COM SEUS CAMPOS EXISTENTES
      const analysisDocument = {
        // Dados b√°sicos (compat√≠veis com sua estrutura)
        nomePoco: analysisData.pocoNome,
        nomeProprietario: analysisData.proprietario,
        idProprietario: analysisData.proprietarioId,
        nomeAnalista: analysisData.analistaNome,
        idAnalista: analysisData.analistaId,
        dataAnalise: analysisData.dataAnalise ? Timestamp.fromDate(new Date(analysisData.dataAnalise)) : serverTimestamp(),
        resultado: analysisData.resultado,
        localizacaoPoco: analysisData.pocoLocalizacao,
        
        // Par√¢metros f√≠sico-qu√≠micos
        temperaturaAr: analysisData.temperaturaAr ? Number(analysisData.temperaturaAr) : 0,
        temperaturaAmostra: analysisData.temperaturaAmostra ? Number(analysisData.temperaturaAmostra) : 0,
        ph: analysisData.ph ? Number(analysisData.ph) : 0,
        alcalinidade: analysisData.alcalinidade ? Number(analysisData.alcalinidade) : 0,
        acidez: analysisData.acidez ? Number(analysisData.acidez) : 0,
        cor: analysisData.cor ? Number(analysisData.cor) : 0,
        turbidez: analysisData.turbidez ? Number(analysisData.turbidez) : 0,
        condutividadeEletrica: analysisData.condutividadeEletrica ? Number(analysisData.condutividadeEletrica) : 0,
        sdt: analysisData.sdt ? Number(analysisData.sdt) : 0,
        sst: analysisData.sst ? Number(analysisData.sst) : 0,
        
        // Par√¢metros qu√≠micos e microbiol√≥gicos
        cloroTotal: analysisData.cloroTotal ? Number(analysisData.cloroTotal) : 0,
        cloroLivre: analysisData.cloroLivre ? Number(analysisData.cloroLivre) : 0,
        coliformesTotais: analysisData.coliformesTotais ? Number(analysisData.coliformesTotais) : 0,
        Ecoli: analysisData.ecoli ? Number(analysisData.ecoli) : 0, // ‚úÖ Note: "Ecoli" com E mai√∫sculo
        
        // Metadados adicionais
        tipoCadastro: analysisData.tipoCadastro || 'direto_admin',
        status: analysisData.status || 'ativa',
        criadoPor: analysisData.criadoPor,
        dataCriacao: serverTimestamp()
      };

      console.log('‚ûï useTabelaAnalises: Enviando para Firebase...', analysisDocument);
      const docRef = await addDoc(analysesCollection, analysisDocument);
      console.log('‚úÖ useTabelaAnalises: An√°lise cadastrada com sucesso! ID:', docRef.id);
      
      return docRef.id;
    } catch (error) {
      console.error('‚ùå useTabelaAnalises: Erro ao adicionar an√°lise:', error);
      throw error;
    }
  };

  // ‚úÖ CORRIGIDO: Fun√ß√£o de editar an√°lise (b√°sica)
  const editAnalysis = async (analysisId, updatedData) => {
    try {
      console.log('‚úèÔ∏è useTabelaAnalises: Editando an√°lise:', analysisId);
      const analysisDoc = doc(db, 'analysis', analysisId);
      await updateDoc(analysisDoc, {
        ...updatedData,
        atualizadoEm: serverTimestamp()
      });
      console.log('‚úÖ useTabelaAnalises: An√°lise editada com sucesso!');
    } catch (error) {
      console.error('‚ùå useTabelaAnalises: Erro ao editar an√°lise:', error);
      throw error;
    }
  };


  const deleteAnalysis = async (analysisId) => {
    try {
      console.log('üóëÔ∏è useTabelaAnalises: Deletando an√°lise:', analysisId);
      const analysisDoc = doc(db, 'analysis', analysisId);
      await deleteDoc(analysisDoc);
      console.log('‚úÖ useTabelaAnalises: An√°lise deletada com sucesso!');
    } catch (error) {
      console.error('‚ùå useTabelaAnalises: Erro ao deletar an√°lise:', error);
      throw error;
    }
  };

  // ‚úÖ CORRIGIDO: Fun√ß√£o de aprovar an√°lise
  const approveAnalysis = async (analysisId) => {
    try {
      console.log('‚úÖ useTabelaAnalises: Aprovando an√°lise:', analysisId);
      const analysisDoc = doc(db, 'analysis', analysisId);
      await updateDoc(analysisDoc, {
        status: 'ativa',
        resultado: 'Aprovada',
        dataAprovacao: serverTimestamp(),
        atualizadoEm: serverTimestamp()
      });
      console.log('‚úÖ useTabelaAnalises: An√°lise aprovada com sucesso!');
    } catch (error) {
      console.error('‚ùå useTabelaAnalises: Erro ao aprovar an√°lise:', error);
      throw error;
    }
  };

  // ‚úÖ CORRIGIDO: Fun√ß√£o de rejeitar an√°lise
  const rejectAnalysis = async (analysisId, motivo) => {
    try {
      console.log('‚ùå useTabelaAnalises: Rejeitando an√°lise:', analysisId);
      const analysisDoc = doc(db, 'analysis', analysisId);
      await updateDoc(analysisDoc, {
        status: 'rejeitada',
        resultado: 'Reprovada',
        motivoRejeicao: motivo,
        dataRejeicao: serverTimestamp(),
        atualizadoEm: serverTimestamp()
      });
      console.log('‚úÖ useTabelaAnalises: An√°lise rejeitada com sucesso!');
    } catch (error) {
      console.error('‚ùå useTabelaAnalises: Erro ao rejeitar an√°lise:', error);
      throw error;
    }
  };

   const sortedAnalyses = useMemo(() => {
    if (!analyses.length) return [];

    const sorted = [...analyses].sort((a, b) => {
      let aValue = a[sortField];
      let bValue = b[sortField];
      
      // Converter para Date se for campo de data
      if (sortField.includes('data')) {
        aValue = aValue?.toDate?.() || new Date(aValue);
        bValue = bValue?.toDate?.() || new Date(bValue);
      }
      
      if (sortDirection === 'asc') {
        return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
      } else {
        return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
      }
    });
    
    return sorted;
  }, [analyses, sortField, sortDirection]);

  const handleSort = (field) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

return {
    analyses: sortedAnalyses,
    pocos,
    analistas,
    loading,
    error,
    sortField,
    sortDirection,
    handleSort,
    addAnalysis,
    editAnalysis, // ‚úÖ Certifique-se que existe
    deleteAnalysis, // ‚úÖ Certifique-se que existe
    approveAnalysis, // ‚úÖ Certifique-se que existe
    rejectAnalysis, // ‚úÖ Certifique-se que existe
  };
};

export default useTabelaAnalises;